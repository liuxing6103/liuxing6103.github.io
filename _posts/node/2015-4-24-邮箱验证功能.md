#邮箱验证功能

有些网站需要邮箱验证，我用搭了一个小东西。很简单，主要就是用了两个库。

##nodemailder

这个库这么来用

先是你的得到你的smtp实例，参数是服务单位，这里是QQ，然后你的授权。

值得注意的是，必须先开启qq邮箱的smtp服务。

  	var nodemailer  = require("nodemailer");
	var user = '261744942@qq.com';
	var pass = 'smq****';
	var smtpTransport = nodemailer.createTransport("SMTP",{
	    service: "QQ",
	    auth: {
	        user: user,
	        pass: pass
	    }
	});

然后开始发邮件。显而易见的参数，node风格的回调函数。邮箱里是可以显示html的，你可以在邮件里加上控制邮箱样式的css文档，不过邮箱客户端会在每个样式前面加上类似于.qmbox（qq邮箱中）的class，以防邮箱用户改变邮箱原有样式。脚本就别妄想插入了，后果你懂得。

	smtpTransport.sendMail({
	    from    : '<261744942@qq.com>',
	    to      : '<'+ _email +'>',
	    subject : 'Node.JS通过SMTP协议从QQ邮箱发送邮件',
	    html    : "<h1>你正在注册这家伙的博客，点击下面的链接进行激活</h1>\
		<a href='http://localhost:3000?vc="+ validCode +"'>lalalallalalalalalallal</a>\
	    <br>"
	}, function(err, res) {
	    console.log(err, res);
	});

注意到vc这个参数，我用它唯一标识这个待验证的用户，暂存在session里面，涉及到用户唯一标识的问题，请看下一话题。

##uuid

邮箱验证用的第二个api。这样就产生了用户唯一标识，这是个业界的标准，每个时空产生的uuid都不同。
	
	var UU = require("node-uuid");
	...
	...
	var buffer = new Buffer(32);
	UU.v1(null ,buffer ,16);
	var validCode = UU.unparse(buffer ,16);

##逻辑问题

首先我的用户表里面有个stat字段，为验证用户的值是0。在点链接时的get请求中要把存着vc的那个session里的值置null，然后把对应用户的stat字段改成1。stat为0的用户在登陆时返回未经过邮箱验证。

我是在用户注册时就在session存了用户的邮箱，然后用req.session.email && !req.session.vc做用户登陆的凭证。这样在注册完成时就直接登陆了。