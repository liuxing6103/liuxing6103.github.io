---
layout: post
category: "node"
---
#顾名思义，一个好用的blog

> 不因为它的简易而失去意义

功能有。通过/blog目录维护个人博客，单个博客在blog目录，分类文章在blog下的子目录里面，博客将对目录自动解析。可以查看总目录，查看某个系列的文章，并对文章的目录进行解析。简单说明一下这个搭建的流程。


##技术选型

nodejs

express

ejs

##目录结构

我使用的是express3.*.*，通过express的命令express blog ejs构建目录的初级模型。然后我又添加了blogs目录和midWares目录，分别存放博客markdown和一些自己写的中间件。

##阶段1

###app.js主文件

主要就是一些中间件的加载，同样我也放置了一个自己的中间件（解析目录）。在就一些路由规则的定义，把执行这些路由的逻辑托付给一些控制器（所谓的就在routes文件夹下面）。最后监听一下。

    
	/**
	 * Module dependencies.
	 */
	
	var express = require('express');
	var http = require('http');
	var path = require('path');
	
	var app = express();
	
	var midWarePath = "./midWares/"
	
	// all environments
	app.set('port', process.env.PORT || 3000);
	app.set('views', path.join(__dirname, 'views'));
	app.set('view engine', 'ejs');
	app.use(express.favicon());
	app.use(express.logger('dev'));
	app.use(express.json());
	app.use(express.urlencoded());
	app.use(express.methodOverride());
	app.use(express.session({ 
		secret: 'your secret here' ,
	}));
	
	app.use(require(midWarePath + "getBlogJson"));
	
	app.use(app.router);
	app.use(express.static(path.join(__dirname, 'public')));
	
	// development only
	if ('development' == app.get('env')) {
	  app.use(express.errorHandler());
	}
	
	var menu = require('./routes/menu');
	var series = require('./routes/series');
	var blog = require('./routes/blog');
	
	app.get('/', blog.index);
	app.get('/blog/:s/:b',blog.subBlog);
	app.get('/blog/:b',blog.singleBlog);
	
	app.get('/menu', menu);
	app.get('/series/:s', series);
	
	
	http.createServer(app).listen(app.get('port'), function(){
	  console.log('Express server listening on port ' + app.get('port'));
	});


### router示例

处理路由的控制器要渲染一个页面，这里是menu.ejs，渲染数据就是render函数的第二个参数（一坨json）。

	module.exports = function(req, res){
		res.render("menu" ,{
			title:"menu" ,
			blogs:req.session.__blogs
		});
	};

###  ejs示例

所谓的视图的一种模板。

include可以请求外部资源，就像php那样，便于重用，易维护。

三种规则<% #这里是js代码# %>

<%- 这里打印输出，不对标签转义 %>

<%= 会转义标签'<'to\&lt %>

这里的markdown就是通过render函数传进来那个参数。传进来什么，json的键值便作为这个里面的一个变量。

	<%- include header %>
	
	<%- include leftBar %>
	
	<section class="bar" id="centerBar">
		<% if(markdown){ %>
			<%- markdown %>
		<% } %>
	</section>
	
	<%- include rightBar %>
	
	<%- include footer %>

###加入markdown解析器

在packege.json中添加依赖"markdown":"*"，在blog控制器里面，处理了三个路由。主页路由我给他index.md，单个博文传一个参数，系列博文传两个参数。然后文件流（balabala）,得到整个markdown的字符，然后调用markdown的toHTML方法，然后打到视图里面。

	// blog.js
	var markdown = require("markdown").markdown;
	var fs = require("fs");
	var path = require("path");
	
	
	function getBlog(res ,req){
		var url = path.join(
			__dirname ,
			"../blogs/" , 
			arguments[2]  ,
			arguments[3] ? "./" + arguments[3] : "" );
		var rs = fs.createReadStream(url + ".md");
	
		rs.on("data" ,function(data){
			res.render('blog',{
				markdown : markdown.toHTML(data.toString()),
				title : arguments[2],
				blogs : req.session.__blogs
			});
		});
	}
	
	module.exports = {
		subBlog : function(req ,res){
			getBlog(res ,req ,req.params.s ,req.params.b);
		} ,
		singleBlog : function(req ,res){
			getBlog(res ,req ,req.params.b);
		} ,
		index : function(req ,res){
			getBlog(res ,req ,"index");
		}
	};

###解析目录的中间件

node常规方法，有个小递归，为多级目录模式留个后路。

	// getBlogJson.js
	var fs = require("fs");
	var path = require("path");
	
	var fileJson = null;
	
	//获取目录的json结构，存放在session里面
	function getBlogJson(req ,res ,next){
		//得到blog的路径
		var dir = path.join(__dirname ,"../blogs/");
		//将返回值存在session里面
		req.session.__blogs = getDirJson(dir);
		next();
	}
	
	function getDirJson(dir){
	
		if(fileJson){ return fileJson };
	
		var re = {};
		//核心函数
		function readFile(cur ,dir){
			//这里用的都是同步方法，异步的没办法递归
			var files = fs.readdirSync(dir),
				length = files.length
				,isPath = true
				,curFile = null
				,curNameString = null
				,curName = null
				,curTime = null;
			if(files.length == 0){ return cur; }
			//遍历一下这里的文件（这里将目录看成是一种文件）
			for(var i = 0 ; i < length ; i ++){
				curFile = files[i];
				var fstate = fs.statSync(path.join(dir ,curFile) );
				isPath = fstate.isDirectory();
				//如果当前文件是目录，当前文件名作为一个键，递归返回一个数组
				if(isPath){
					cur[curFile] = arguments.callee([] ,path.join(dir ,curFile))
				//如果是个文件，或者作为键值，或者作为数组中的一个元素
				}else{
					//这个预留为about
					if(curFile == "index.md"){
						continue;
					}
					//更新时间和文件id
					curTime = fstate.ctime;
					var id = fstate.ino;
	
					curNameString = curFile.split(".")[0]
					if(cur instanceof Array){
						cur.push({
							name : curNameString ,
							time : curTime ,
							id : id
						})
					}else{
						cur[curNameString] = {
							time : curTime ,
							id : id
						};
					}
				}
			}
	
			return cur;
			
		};
	
		fileJson =  readFile(re ,dir);
		console.log(fileJson);
		return fileJson
	}
	
	module.exports = getBlogJson;

##阶段2
	
###评论功能

搭了个评论系统，这个网上有一些，我用的是[多说](http://duoshuo.com)。这样就省的写登陆注册什么的，而且有第三方登陆功能，这样用户在评论你的时候也很方便。

###更新日期的修改

fs.stat对象中有更新时间，获取文件目录的时候记录一下就可以了。

